{# templates/_meta.html.twig
   Focused SEO / Open Graph / Twitter / JSON-LD partial.
   - Safe: never assumes `meta` exists.
   - Groups tags by type and uses absolute URLs when possible.
#}
{% set _meta = meta is defined ? meta : {} %}

{# Site defaults (consider moving to twig globals) #}
{% set site_defaults = {
  title: 'XLMFISH â€” Transparency & Analytics',
  description: 'XLMFISH: transparency, analytics, and community tools for the Stellar ecosystem.',
  image: 'https://xlm.fish/xlmfish_sm.png',
  twitter_site: '@xlmfish',
  type: 'website',
  logo_image: 'https://xlm.fish/xlmfish_sm.png'
} %}

{# Page values with defaults #}
{% set title = _meta.title is defined ? _meta.title : site_defaults.title %}
{% set description = _meta.description is defined ? _meta.description : site_defaults.description %}
{% set image_path = _meta.image is defined ? _meta.image : site_defaults.image %}
{% set logo_path = _meta.logo_image is defined ? _meta.logo_image : site_defaults.logo_image %}
{% set og_type = _meta.type is defined ? _meta.type : site_defaults.type %}
{% set twitter_card = _meta.twitter_card is defined ? _meta.twitter_card : 'summary_large_image' %}
{% set twitter_site = _meta.twitter_site is defined ? _meta.twitter_site : site_defaults.twitter_site %}
{% set twitter_creator = _meta.twitter_creator is defined ? _meta.twitter_creator : twitter_site %}
{% set robots = _meta.robots is defined ? _meta.robots : 'index,follow' %}

{# Canonical / URL: prefer explicit meta.url, otherwise derive from request if available #}
{% if _meta.url is defined and _meta.url %}
  {% set canonical = _meta.url %}
{% elseif app.request is defined and app.request.uri is defined %}
  {% set canonical = (absolute_url is defined) ? absolute_url(app.request.uri) : app.request.uri %}
{% else %}
  {% set canonical = '' %}
{% endif %}

{# Build absolute URLs for images when helpers are available; otherwise fall back to the raw path #}
{% set image_url = (image_path and absolute_url is defined and asset is defined) ? absolute_url(asset(image_path)) : (image_path ?: '') %}
{% set logo_url = (logo_path and absolute_url is defined and asset is defined) ? absolute_url(asset(logo_path)) : (logo_path ?: '') %}

{# ----- Group: Title + Basic meta ----- #}
<title>{{ title|e }}</title>
<meta name="description" content="{{ description|striptags|trim|e('html_attr') }}" />
<meta name="robots" content="{{ robots }}" />
{% if canonical is not empty %}
<link rel="canonical" href="{{ canonical }}" />
{% endif %}

{# ----- Group: Open Graph (OG) ----- #}
<meta property="og:locale" content="{{ app.request.locale is defined ? app.request.locale : 'en_US' }}" />
<meta property="og:type" content="{{ og_type }}" />
<meta property="og:title" content="{{ title|e }}" />
<meta property="og:description" content="{{ description|striptags|trim|e('html_attr') }}" />
{% if canonical is not empty %}<meta property="og:url" content="{{ canonical }}" />{% endif %}
{% if image_url %}<meta property="og:image" content="{{ image_url }}" />{% endif %}
{% if image_url and _meta.image_width is defined %}<meta property="og:image:width" content="{{ _meta.image_width }}" />{% endif %}
{% if image_url and _meta.image_height is defined %}<meta property="og:image:height" content="{{ _meta.image_height }}" />{% endif %}

{# ----- Group: Twitter Card ----- #}
<meta name="twitter:card" content="{{ twitter_card }}" />
<meta name="twitter:site" content="{{ twitter_site }}" />
<meta name="twitter:creator" content="{{ twitter_creator }}" />
<meta name="twitter:title" content="{{ title|e }}" />
<meta name="twitter:description" content="{{ description|striptags|trim|e('html_attr') }}" />
{% if image_url %}<meta name="twitter:image" content="{{ image_url }}" />{% endif %}

{# ----- Group: Viewport & misc ----- #}
<meta name="viewport" content="width=device-width, initial-scale=1" />

{# ----- Group: JSON-LD structured data ----- #}
{% set jsonld = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "url": (canonical is not empty ? canonical : ""),
  "name": title,
  "description": description,
  "publisher": {
    "@type": "Organization",
    "name": "XLMFISH",
    "logo": {
      "@type": "ImageObject",
      "url": (logo_url is not empty ? logo_url : "")
    }
  }
} %}
<script type="application/ld+json">{{ jsonld|json_encode(constant('JSON_UNESCAPED_SLASHES') b-or constant('JSON_PRETTY_PRINT'))|raw }}</script>
